<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue 源码目录及构建过程分析 | Jeffery Blog</title>
    <meta name="description" content="记录和分享技术">
    <link rel="icon" href="/images/photo.jpg">
  <link rel="manifest" href="/images/photo.jpg">
  <link rel="apple-touch-icon" href="/images/photo.jpg">
  <meta http-quiv="pragma" cotent="no-cache">
  <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
  <meta http-quiv="expires" cotent="0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    
    <link rel="preload" href="/assets/css/0.styles.83e51879.css" as="style"><link rel="preload" href="/assets/js/app.f96d0dc8.js" as="script"><link rel="preload" href="/assets/js/40.e55debb3.js" as="script"><link rel="prefetch" href="/assets/js/10.8506b9fc.js"><link rel="prefetch" href="/assets/js/11.2ac88bab.js"><link rel="prefetch" href="/assets/js/12.ae3ae057.js"><link rel="prefetch" href="/assets/js/13.4a7cb9d2.js"><link rel="prefetch" href="/assets/js/14.50a65c01.js"><link rel="prefetch" href="/assets/js/15.2c09bf95.js"><link rel="prefetch" href="/assets/js/16.fe1d8458.js"><link rel="prefetch" href="/assets/js/17.76935e2c.js"><link rel="prefetch" href="/assets/js/18.a3e9694d.js"><link rel="prefetch" href="/assets/js/19.d4d9a945.js"><link rel="prefetch" href="/assets/js/2.e1a2e5a6.js"><link rel="prefetch" href="/assets/js/20.c6f91d1d.js"><link rel="prefetch" href="/assets/js/21.9daaa140.js"><link rel="prefetch" href="/assets/js/22.706a5717.js"><link rel="prefetch" href="/assets/js/23.b55e5f59.js"><link rel="prefetch" href="/assets/js/24.e57fd181.js"><link rel="prefetch" href="/assets/js/25.de753c09.js"><link rel="prefetch" href="/assets/js/26.75e03a0a.js"><link rel="prefetch" href="/assets/js/27.0f39ac24.js"><link rel="prefetch" href="/assets/js/28.b4f1e26a.js"><link rel="prefetch" href="/assets/js/29.7e147ce9.js"><link rel="prefetch" href="/assets/js/3.fca730b7.js"><link rel="prefetch" href="/assets/js/30.08287792.js"><link rel="prefetch" href="/assets/js/31.4a26cbda.js"><link rel="prefetch" href="/assets/js/32.5b443424.js"><link rel="prefetch" href="/assets/js/33.4fd4b08b.js"><link rel="prefetch" href="/assets/js/34.a31c0f36.js"><link rel="prefetch" href="/assets/js/35.88cafe94.js"><link rel="prefetch" href="/assets/js/36.7812381a.js"><link rel="prefetch" href="/assets/js/37.5f9f2adb.js"><link rel="prefetch" href="/assets/js/38.118ba1f4.js"><link rel="prefetch" href="/assets/js/39.b67f7277.js"><link rel="prefetch" href="/assets/js/4.9e7532a1.js"><link rel="prefetch" href="/assets/js/41.d7903d06.js"><link rel="prefetch" href="/assets/js/42.77614d76.js"><link rel="prefetch" href="/assets/js/43.b81eee3a.js"><link rel="prefetch" href="/assets/js/44.4ade92d1.js"><link rel="prefetch" href="/assets/js/45.8bea4d57.js"><link rel="prefetch" href="/assets/js/46.3bdb04e6.js"><link rel="prefetch" href="/assets/js/47.c894c4b2.js"><link rel="prefetch" href="/assets/js/48.78e60e2b.js"><link rel="prefetch" href="/assets/js/49.9c5c8f7d.js"><link rel="prefetch" href="/assets/js/5.a3c90268.js"><link rel="prefetch" href="/assets/js/50.832279c4.js"><link rel="prefetch" href="/assets/js/51.cc16f222.js"><link rel="prefetch" href="/assets/js/52.b28aa4d0.js"><link rel="prefetch" href="/assets/js/53.ebabf090.js"><link rel="prefetch" href="/assets/js/54.28bdfc99.js"><link rel="prefetch" href="/assets/js/55.a1b4df06.js"><link rel="prefetch" href="/assets/js/56.6fb0c31d.js"><link rel="prefetch" href="/assets/js/57.b9df5c2d.js"><link rel="prefetch" href="/assets/js/58.47940a92.js"><link rel="prefetch" href="/assets/js/6.4133d95a.js"><link rel="prefetch" href="/assets/js/7.ea728375.js"><link rel="prefetch" href="/assets/js/8.b6825a68.js"><link rel="prefetch" href="/assets/js/9.4d493f14.js">
    <link rel="stylesheet" href="/assets/css/0.styles.83e51879.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Jeffery Blog</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue/vue-home.html" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/web/javascript/home.html" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/web/typescript/guide.html" class="nav-link">TypeScript</a></li><li class="dropdown-item"><!----> <a href="/web/html/" class="nav-link">HTML</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/vscode/shortcut-key.html" class="nav-link">VS Code</a></li><li class="dropdown-item"><!----> <a href="/tools/git/basics.html" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/tools/gitlab/webhook.html" class="nav-link">GitLab</a></li><li class="dropdown-item"><!----> <a href="/tools/develop/doc.html" class="nav-link">工具库</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端基建</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/infrastructure/performance/01-optimize-index.html" class="nav-link">性能优化</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/JefferyXZF" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue/vue-home.html" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/web/javascript/home.html" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/web/typescript/guide.html" class="nav-link">TypeScript</a></li><li class="dropdown-item"><!----> <a href="/web/html/" class="nav-link">HTML</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/vscode/shortcut-key.html" class="nav-link">VS Code</a></li><li class="dropdown-item"><!----> <a href="/tools/git/basics.html" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/tools/gitlab/webhook.html" class="nav-link">GitLab</a></li><li class="dropdown-item"><!----> <a href="/tools/develop/doc.html" class="nav-link">工具库</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端基建</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/infrastructure/performance/01-optimize-index.html" class="nav-link">性能优化</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/JefferyXZF" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/vue/vue-home.html" class="sidebar-link">Vue 技术目录</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>vue 最佳实践</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>vue 源码解析</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/vue/vue-code-1.package.html" class="sidebar-link">package.json 属性详解</a></li><li><a href="/vue/vue-code-2.rollup.html" class="sidebar-link">rollup 教程</a></li><li><a href="/vue/vue-code-3.build.html" aria-current="page" class="active sidebar-link">Vue 源码目录及构建过程分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue/vue-code-3.build.html#vue-源码目录结构" class="sidebar-link">Vue 源码目录结构</a></li><li class="sidebar-sub-header"><a href="/vue/vue-code-3.build.html#vue-源码构建" class="sidebar-link">Vue 源码构建</a></li><li class="sidebar-sub-header"><a href="/vue/vue-code-3.build.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/vue/vue-code-4.debugger.html" class="sidebar-link">Vue 源码入门和调试指南</a></li><li><a href="/vue/vue-code-5.mergeOptions.html" class="sidebar-link">Vue 丰富的选项合并策略</a></li><li><a href="/vue/vue-code-6.reactive.html" class="sidebar-link">数据响应式原理</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="vue-源码目录及构建过程分析"><a href="#vue-源码目录及构建过程分析" class="header-anchor">#</a> Vue 源码目录及构建过程分析</h1> <p>梳理 <code>Vue</code> 源码的目录结构，以及 <code>Vue</code> 源码构建流程，对 Vue 源码有一个整体了解，有助于后续对源码的阅读</p> <h2 id="vue-源码目录结构"><a href="#vue-源码目录结构" class="header-anchor">#</a> Vue 源码目录结构</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>|——.github ------------------------------- github 贡献指南，包括代码提交规范、issue规范、PR规范等
|—— benchmarks ---------------------------- 性能测试文件
|—— dist ---------------------------------- rollup 构建输出不同版本 vue 文件
|—— examples ------------------------------ vue 使用的一些 demo
|—— flow ---------------------------------- JS静态类型检查工具 [Flow](https://flowtype.org/) 的类型声明
|—— packages ------------------------------ 独立的 vue 相关 npm 包
|—— scripts ------------------------------- 包含与构建相关的脚本和配置文件
│   ├── alias.js -------------------------- 源码中使用到的模块导入别名
│   ├── build.js -------------------------- 构建打包输出文件路径
│   ├── config.js ------------------------- 项目的构建配置
├── src ----------------------------------- 源码目录
│   ├── compiler -------------------------- 编译器代码，用来将 template 编译为 render 函数
│   │   ├── codegen ----------------------- 存放从抽象语法树(AST)生成 render 函数的代码
│   │   ├── directives --------------------- v-on, v-bind, v-cloak, v-model 指令
│   │   ├── parser ------------------------ 存放将模板字符串转换成元素 AST 抽象语法树的代码
│   │   ├── create-compiler.js ------------- createCompilerCreator 方法 返回 compile，compileToFunctions
│   │   ├── optimizer.js ------------------ 分析静态树，优化 vdom 渲染
│   ├── core ------------------------------ 存放通用的，平台无关的运行时代码
│   │   ├── components -------------------- 包含抽象出来的通用组件，目前只有keep-alive
│   │   ├── global-api -------------------- 给 Vue 构造函数挂载全局方法(静态方法)或属性的代码(config, set, delete, extend, nextTick……)
│   │   ├── instance ---------------------- Vue构造函数与原型相关代码
│   │   ├── observer ---------------------- 响应式实现，包含数据观测的核心代码
│   │   ├── vdom -------------------------- 虚拟DOM的 creation 和 patching 的代码
│   ├── server ---------------------------- 服务端渲染(server-side rendering)的相关代码
│   ├── platforms ------------------------- 不同平台特有的相关代码
│   │   ├── weex -------------------------- weex 平台支持
│   │   ├── web --------------------------- web平台支持
│   │   │   ├── entry-runtime.js ---------------- 运行时构建的入口
│   │   │   ├── entry-runtime-with-compiler.js -- 运行时+编译器构建版本的入口
│   │   │   ├── entry-compiler.js --------------- vue-template-compiler 包的入口文件
│   │   │   ├── entry-server-renderer.js -------- vue-server-renderer 包的入口文件
│   ├── sfc ------------------------------- 包含单文件组件(.vue文件)的解析逻辑，用于vue-template-compiler包
│   ├── shared ---------------------------- 整个代码库通用的代码
|   |    
├── test ---------------------------------- 测试文件
├── types --------------------------------- TypeScript 类声明文件
├── .flowconfig ---------------------------- flow 配置文件
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h3 id="compiler"><a href="#compiler" class="header-anchor">#</a> compiler</h3> <p>该目录是编译相关的代码，将 <code>template</code> 模板转化成 <code>render</code> 函数的代码。</p> <p><code>vue</code> 提供了 <code>render</code> 函数，<code>render</code> 函数作用是用来创建 <code>VNode</code>，但在平时开发中，绝大多数情况下使用 el 或 template 来创建 HTML，所以需要将它们编译成 render 函数。</p> <p>编译工作既可以在代码构建时做，也可以在客户端运行时做，但编译十分消耗性能，所以在项目中建议使用 runtime 版本</p> <h3 id="core"><a href="#core" class="header-anchor">#</a> core</h3> <p>这部分代码是 vue 的核心代码，可以说是 vue 的灵魂所在，也是我们要重点学习的源码。</p> <p>core 目录又包含如下子目录。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>|—— components ---------------------------- 内置组件的代码，即 keep-alive 代码
|—— global-api ---------------------------- 全局 API 代码, 全局属性：config、util; 
全局方法：set、delete、nextTick、observable、options(components, directives, filters, _base)、Vue.use、Vue.mixin、Vue.extend、Vue.component、Vue.directive、Vue.filter
|—— instance ------------------------------- vue 实例化相关代码
│   ├── event.js -------------------------- initEvents, add 添加事件监听, remove 移除事件监听, eventsMixin
│   ├── index.js -------------------------- 定义 Vue 构造函数，添加原型属性和方法；initMixin，stateMixin，eventsMixin，lifecycleMixin，renderMixin
│   ├── init.js ---------------------------- 定义 initMixin
│   ├── inject.js -------------------------- 定义 initInjections
│   ├── lifecycle.js ----------------------- 定义 lifecycleMixin
│   ├── proxy.js --------------------------- 定义 initProxy
│   ├── render.js -------------------------- 定义 renderMixin，initRender
│   ├── state.js --------------------------- 定义 initState，initProps, initData, initComputed, initMethods, initWatch, stateMixin
|—— observer ------------------------------ 数据响应式
│   ├── array.js -------------------------- 重写数组方法 'push', 'pop', 'shift', 'unshift', 'splice', 'sort', 'reverse'
│   ├── dep.js ---------------------------- 依赖收集 Dep 类，方法(addSub, removeSub, depend, notify, pushTarget, popTarget)
│   ├── index.js --------------------------- 构建响应式系统 (Observer, observe, defineReactive, set, del)
│   ├── watch.js --------------------------- 数据监听 Watcher（get, addDep, cleanupDeps, update, run , evaluate, depend, teardown)
|—— vdom ----------------------------------- 虚拟 DOM 和组件创建，patch 更新真实 DOM
│   ├── create-component.js ---------------- 组件钩子函数(init, prepatch, insert, destroy ), createComponent 创建组件
│   ├── create-element.js ------------------ createElement 创建元素 (原生标签 - new Vnode, 组件 -&gt; createComponent)
│   ├── create-functional.component.js ----- 创建函数式组件
│   ├── patch.js --------------------------- createPatchFunction， createElm, createComponent diff算法，跟新真实DOM
│   ├── vnode.js --------------------------- VNode 类

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>添加原型属性和方法</p> <ul><li>initMixin：添加 <code>_init</code> 方法</li> <li>stateMixin：添加 <code>$data</code>, <code>$props</code>, <code>$set</code>, <code>$delete</code>, <code>$watch</code></li> <li>eventsMixin 添加 <code>$on</code>, <code>$once</code>, <code>$off</code>, <code>$emit</code> 方法</li> <li>lifecycleMixin 添加 <code>_update</code>, <code>$forceUpdate</code>, <code>$destroy</code> 方法</li> <li>renderMixin：添加 <code>$nextTick</code>, <code>_render</code> 方法</li></ul> <h3 id="platforms"><a href="#platforms" class="header-anchor">#</a> platforms</h3> <p><code>platforms</code> 下包含两个子目录，<code>web</code> 和 <code>weex</code>。</p> <p>分别代表可以打包生成在 web 端使用的 vue 代码和在 native 端使用的 weex 代码。美团开源的开发微信小程序的 mpvue 框架也是在这个目录下进行拓展的。</p> <p>通过不同平台的入口就可以打包出运行在不同平台的版本的 vue 文件。</p> <h3 id="server"><a href="#server" class="header-anchor">#</a> server</h3> <p>该目录下是 SSR 相关的代码。</p> <p>Vue.js 是构建客户端应用程序的框架。除了可以在浏览器中输出 Vue 组件，也可以将同一个组件渲染为服务器端的 HTML 字符串，将它们直接发送到浏览器，最后将这些静态标记”激活”为客户端上完全可交互的应用程序。</p> <h3 id="sfc"><a href="#sfc" class="header-anchor">#</a> sfc</h3> <p>我们平时开发时，都是写 .vue 文件。sfc 的代码就是提供一个解析器，把.vue 文件代码解析成一个 javascript 对象。</p> <h3 id="shared"><a href="#shared" class="header-anchor">#</a> shared</h3> <p>该目录下定义了一些公用的工具方法，提供给上面的几个目录内代码使用。</p> <h2 id="vue-源码构建"><a href="#vue-源码构建" class="header-anchor">#</a> Vue 源码构建</h2> <p>vue 的源码按照功能拆分的十分清晰，每个功能都有单独的目录，那么项目中引用的 vue 文件是怎么编译出来的呢？</p> <p>首先，我们看一下编译输出的 dist 目录。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>|—— dist 
│   ├── vue.common.dev.js // common.js 规范未压缩开发版本
│   ├── vue.common.prod.js // common.js 规范压缩生产版本
│   ├── vue.esm.browser.js 
│   ├── vue.esm.browser.min.js 
│   ├── vue.esm.js // ES Module 规范
│   ├── vue.js  // UMD 规范
│   ├── vue.min.js // UMD 规范压缩版本
│   ├── vue.runtime.common.dev.js // runtime only 版本
│   ├── vue.runtime.common.js 
│   ├── vue.runtime.common.prod.js 
│   ├── vue.runtime.esm.js 
│   ├── vue.runtime.js 
│   ├── vue.runtime.min.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>可以看到，dist 下有 10 几种不同版本的 vue 文件，他们是根据不同规范（包括 CommonJS 规范，ES Module，UMD）和 是否包含编译器 构建出的不同版本。</p> <p>vue 源码选择了 rollup 进行构建，rollup 相比于 webpack，更加轻量，编译后的代码更加干净，更适合 javascript 库的构建，除了 vue 以外，像 React，Ember，D3，Three.js 以及其他很多开源库也选择了 Rollup 进行构建。</p> <p>下面看一下 vue 具体构建过程，首先到 pakage.json 中看下 vue 编译执行的命令。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>    <span class="token string">&quot;dev&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rollup -w -c scripts/config.js --source-map --environment TARGET:web-full-dev&quot;</span>,
    <span class="token string">&quot;dev:cjs&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rollup -w -c scripts/config.js --environment TARGET:web-runtime-cjs-dev&quot;</span>,
    <span class="token string">&quot;dev:esm&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rollup -w -c scripts/config.js --environment TARGET:web-runtime-esm&quot;</span>,
    <span class="token string">&quot;build&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;node scripts/build.js&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>从命令可以看出，构建命令就是执行 scripts 目录下 build.js 文件。</p> <p>下面是 scripts/build.js 核心代码</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 判断是否存在 dist 目录，不存在就创建 dist</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 读取构建需要的配置</span>
<span class="token keyword">let</span> builds <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAllBuilds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 根据构建命令传入的参数过滤配置，过滤后的配置构建出不同 vue 版本文件</span>
<span class="token comment">// filter builds via command line arg</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> filters <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
  builds <span class="token operator">=</span> builds<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">b</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> filters<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">f</span> <span class="token operator">=&gt;</span> b<span class="token punctuation">.</span>output<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> b<span class="token punctuation">.</span>_name<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// filter out weex builds by default</span>
  builds <span class="token operator">=</span> builds<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">b</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> b<span class="token punctuation">.</span>output<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'weex'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">build</span><span class="token punctuation">(</span>builds<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>从代码可以看出，首先通过 script/config.js 文件的 getAllBuilds 方法获取配置，然后根据构建命令传入的参数对配置进行过滤，最后根据过滤后的配置执行 build 函数，编译出对应版本的 vue 文件。</p> <p>看一下 build 方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">build</span> <span class="token punctuation">(</span><span class="token parameter">builds</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> built <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">const</span> total <span class="token operator">=</span> builds<span class="token punctuation">.</span>length
  <span class="token keyword">const</span> <span class="token function-variable function">next</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">buildEntry</span><span class="token punctuation">(</span>builds<span class="token punctuation">[</span>built<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 递归处理构建输出文件</span>
      built<span class="token operator">++</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>built <span class="token operator">&lt;</span> total<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>logError<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>上面可以看到，build 方法递归的调用 <code>next</code> 方法，<code>next</code> 方法调用 <code>buildEntry</code> 打包输出</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">buildEntry</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> output <span class="token operator">=</span> config<span class="token punctuation">.</span>output
  <span class="token keyword">const</span> <span class="token punctuation">{</span> file<span class="token punctuation">,</span> banner <span class="token punctuation">}</span> <span class="token operator">=</span> output
  <span class="token keyword">const</span> isProd <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(min|prod)\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token comment">// 生产版本</span>
  <span class="token keyword">return</span> rollup<span class="token punctuation">.</span><span class="token function">rollup</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">bundle</span> <span class="token operator">=&gt;</span> bundle<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> output<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> code <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 生产版本开启代码压缩</span>
        <span class="token keyword">const</span> minified <span class="token operator">=</span> <span class="token punctuation">(</span>banner <span class="token operator">?</span> banner <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> terser<span class="token punctuation">.</span><span class="token function">minify</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          toplevel<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          output<span class="token operator">:</span> <span class="token punctuation">{</span>
            ascii_only<span class="token operator">:</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          compress<span class="token operator">:</span> <span class="token punctuation">{</span>
            pure_funcs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'makeMap'</span><span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>code
        <span class="token keyword">return</span> <span class="token function">write</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> minified<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">write</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> code<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>接下来我们在看一下配置文件 script/config.js 中的 getAllBuilds 是怎么获取具体配置的。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TARGET</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">genConfig</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TARGET</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  exports<span class="token punctuation">.</span>getBuild <span class="token operator">=</span> genConfig
  exports<span class="token punctuation">.</span><span class="token function-variable function">getAllBuilds</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>builds<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>genConfig<span class="token punctuation">)</span> <span class="token comment">// </span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可以看出，getAllBuilds 方法首先通过 Object.keys 拿到 builds 对象所有 key 的组成的数组，并通过 map 遍历执行 genConfig 方法。下面我们先看一下 builds 对象。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> aliases <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./alias'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">p</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> base <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>aliases<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>aliases<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> builds <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// Runtime only (CommonJS). Used by bundlers e.g. Webpack &amp; Browserify</span>
  <span class="token string">'web-runtime-cjs-dev'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.runtime.common.dev.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span>
    env<span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
    banner
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'web-runtime-cjs-prod'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.runtime.common.prod.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span>
    env<span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
    banner
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// Runtime+compiler CommonJS build (CommonJS)</span>
  <span class="token string">'web-full-cjs-dev'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime-with-compiler.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.common.dev.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span>
    env<span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{</span> he<span class="token operator">:</span> <span class="token string">'./entity-decoder'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    banner
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'web-full-cjs-prod'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime-with-compiler.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.common.prod.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span>
    env<span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{</span> he<span class="token operator">:</span> <span class="token string">'./entity-decoder'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    banner
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// Runtime only ES modules build (for bundlers)</span>
  <span class="token string">'web-runtime-esm'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.runtime.esm.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'es'</span><span class="token punctuation">,</span>
    banner
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// Runtime+compiler ES modules build (for bundlers)</span>
  <span class="token string">'web-full-esm'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime-with-compiler.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.esm.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'es'</span><span class="token punctuation">,</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{</span> he<span class="token operator">:</span> <span class="token string">'./entity-decoder'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    banner
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// Runtime+compiler ES modules build (for direct import in browser)</span>
  <span class="token string">'web-full-esm-browser-dev'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime-with-compiler.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.esm.browser.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'es'</span><span class="token punctuation">,</span>
    transpile<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    env<span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{</span> he<span class="token operator">:</span> <span class="token string">'./entity-decoder'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    banner
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// Runtime+compiler ES modules build (for direct import in browser)</span>
  <span class="token string">'web-full-esm-browser-prod'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime-with-compiler.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.esm.browser.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'es'</span><span class="token punctuation">,</span>
    transpile<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    env<span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{</span> he<span class="token operator">:</span> <span class="token string">'./entity-decoder'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    banner
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// runtime-only build (Browser)</span>
  <span class="token string">'web-runtime-dev'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.runtime.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>
    env<span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
    banner
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// runtime-only production build (Browser)</span>
  <span class="token string">'web-runtime-prod'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.runtime.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>
    env<span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
    banner
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// Runtime+compiler development build (Browser)</span>
  <span class="token string">'web-full-dev'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime-with-compiler.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>
    env<span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{</span> he<span class="token operator">:</span> <span class="token string">'./entity-decoder'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    banner
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// Runtime+compiler production build  (Browser)</span>
  <span class="token string">'web-full-prod'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime-with-compiler.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>
    env<span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{</span> he<span class="token operator">:</span> <span class="token string">'./entity-decoder'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    banner
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// Web compiler (CommonJS).</span>
  <span class="token string">'web-compiler'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-compiler.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'packages/vue-template-compiler/build.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span>
    external<span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../packages/vue-template-compiler/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// Web compiler (UMD for in-browser use).</span>
  <span class="token string">'web-compiler-browser'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-compiler.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'packages/vue-template-compiler/browser.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>
    env<span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
    moduleName<span class="token operator">:</span> <span class="token string">'VueTemplateCompiler'</span><span class="token punctuation">,</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cjs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// Web server renderer (CommonJS).</span>
  <span class="token string">'web-server-renderer-dev'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-server-renderer.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'packages/vue-server-renderer/build.dev.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span>
    env<span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
    external<span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../packages/vue-server-renderer/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'web-server-renderer-prod'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-server-renderer.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'packages/vue-server-renderer/build.prod.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span>
    env<span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
    external<span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../packages/vue-server-renderer/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'web-server-renderer-basic'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-server-basic-renderer.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'packages/vue-server-renderer/basic.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>
    env<span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
    moduleName<span class="token operator">:</span> <span class="token string">'renderVueComponentToString'</span><span class="token punctuation">,</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cjs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'web-server-renderer-webpack-server-plugin'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'server/webpack-plugin/server.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'packages/vue-server-renderer/server-plugin.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span>
    external<span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../packages/vue-server-renderer/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'web-server-renderer-webpack-client-plugin'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'server/webpack-plugin/client.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'packages/vue-server-renderer/client-plugin.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span>
    external<span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../packages/vue-server-renderer/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// Weex runtime factory</span>
  <span class="token string">'weex-factory'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    weex<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'weex/entry-runtime-factory.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'packages/weex-vue-framework/factory.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>weexFactoryPlugin<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// Weex runtime framework (CommonJS).</span>
  <span class="token string">'weex-framework'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    weex<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'weex/entry-framework.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'packages/weex-vue-framework/index.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'cjs'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// Weex compiler (CommonJS). Used by Weex's Webpack loader.</span>
  <span class="token string">'weex-compiler'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    weex<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    entry<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'weex/entry-compiler.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dest<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'packages/weex-template-compiler/build.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span>
    external<span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../packages/weex-template-compiler/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br></div></div><p>可以看出，builds 对象是不同版本 vue 的编译配置</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genConfig</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> opts <span class="token operator">=</span> builds<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    input<span class="token operator">:</span> opts<span class="token punctuation">.</span>entry<span class="token punctuation">,</span> <span class="token comment">// 打包入口</span>
    external<span class="token operator">:</span> opts<span class="token punctuation">.</span>external<span class="token punctuation">,</span> <span class="token comment">// 第三方依赖或独立 npm 包</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token function">flow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">alias</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> aliases<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>alias<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>plugins <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    output<span class="token operator">:</span> <span class="token punctuation">{</span>
      file<span class="token operator">:</span> opts<span class="token punctuation">.</span>dest<span class="token punctuation">,</span> <span class="token comment">// 打包输出文件</span>
      format<span class="token operator">:</span> opts<span class="token punctuation">.</span>format<span class="token punctuation">,</span> <span class="token comment">// 文件规范 umd, commonjs, esm</span>
      banner<span class="token operator">:</span> opts<span class="token punctuation">.</span>banner<span class="token punctuation">,</span>
      name<span class="token operator">:</span> opts<span class="token punctuation">.</span>moduleName <span class="token operator">||</span> <span class="token string">'Vue'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">onwarn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> warn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">Circular</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// built-in vars</span>
  <span class="token keyword">const</span> vars <span class="token operator">=</span> <span class="token punctuation">{</span>
    __WEEX__<span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>opts<span class="token punctuation">.</span>weex<span class="token punctuation">,</span>
    __WEEX_VERSION__<span class="token operator">:</span> weexVersion<span class="token punctuation">,</span>
    __VERSION__<span class="token operator">:</span> version
  <span class="token punctuation">}</span>
  <span class="token comment">// feature flags</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>featureFlags<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    vars<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">process.env.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> featureFlags<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// build-specific env</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>env<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vars<span class="token punctuation">[</span><span class="token string">'process.env.NODE_ENV'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>env<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  config<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">replace</span><span class="token punctuation">(</span>vars<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>transpile <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">buble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token string">'_name'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    value<span class="token operator">:</span> name
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> config
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p><code>genConfig</code> 通过 key 拿到 builds 中每个 key 对应的配置对象，然后根据这个对象重新定义一个 config 对象，这个 config 对象的结构才是 rollup 配置真正需要的结构。</p> <p>看了 builds 对象和 genConfig 方法，我们就知道了 getAllBuilds 的目的，是通过映射把 builds 配置对象转化成 rollup 所需要的配置数据。</p> <p>到这里，我们就清楚是如何构建出不同版本的 vue 代码了。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>学习源码时，不建议按照源码的顺序一行一行的阅读。首先要抓住主干，先梳理清楚主要的代码逻辑，再去仔细阅读具体的每行代码。另外按照源码顺序阅读可能很枯燥，很难坚持下来，可以先选择自己感兴趣的部分进行学习，最后再串联起来。</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/vue/vue-code-2.rollup.html" class="prev">
          rollup 教程
        </a></span> <span class="next"><a href="/vue/vue-code-4.debugger.html">
          Vue 源码入门和调试指南
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.f96d0dc8.js" defer></script><script src="/assets/js/40.e55debb3.js" defer></script>
  </body>
</html>
