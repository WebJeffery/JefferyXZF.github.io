<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>从零搭建组件库框架 | Jeffery Blog</title>
    <meta name="description" content="记录和分享技术">
    <link rel="icon" href="/images/photo.jpg">
  <link rel="manifest" href="/images/photo.jpg">
  <link rel="apple-touch-icon" href="/images/photo.jpg">
  <meta http-quiv="pragma" cotent="no-cache">
  <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
  <meta http-quiv="expires" cotent="0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    
    <link rel="preload" href="/assets/css/0.styles.83e51879.css" as="style"><link rel="preload" href="/assets/js/app.f96d0dc8.js" as="script"><link rel="preload" href="/assets/js/11.2ac88bab.js" as="script"><link rel="prefetch" href="/assets/js/10.8506b9fc.js"><link rel="prefetch" href="/assets/js/12.ae3ae057.js"><link rel="prefetch" href="/assets/js/13.4a7cb9d2.js"><link rel="prefetch" href="/assets/js/14.50a65c01.js"><link rel="prefetch" href="/assets/js/15.2c09bf95.js"><link rel="prefetch" href="/assets/js/16.fe1d8458.js"><link rel="prefetch" href="/assets/js/17.76935e2c.js"><link rel="prefetch" href="/assets/js/18.a3e9694d.js"><link rel="prefetch" href="/assets/js/19.d4d9a945.js"><link rel="prefetch" href="/assets/js/2.e1a2e5a6.js"><link rel="prefetch" href="/assets/js/20.c6f91d1d.js"><link rel="prefetch" href="/assets/js/21.9daaa140.js"><link rel="prefetch" href="/assets/js/22.706a5717.js"><link rel="prefetch" href="/assets/js/23.b55e5f59.js"><link rel="prefetch" href="/assets/js/24.e57fd181.js"><link rel="prefetch" href="/assets/js/25.de753c09.js"><link rel="prefetch" href="/assets/js/26.75e03a0a.js"><link rel="prefetch" href="/assets/js/27.0f39ac24.js"><link rel="prefetch" href="/assets/js/28.b4f1e26a.js"><link rel="prefetch" href="/assets/js/29.7e147ce9.js"><link rel="prefetch" href="/assets/js/3.fca730b7.js"><link rel="prefetch" href="/assets/js/30.08287792.js"><link rel="prefetch" href="/assets/js/31.4a26cbda.js"><link rel="prefetch" href="/assets/js/32.5b443424.js"><link rel="prefetch" href="/assets/js/33.4fd4b08b.js"><link rel="prefetch" href="/assets/js/34.a31c0f36.js"><link rel="prefetch" href="/assets/js/35.88cafe94.js"><link rel="prefetch" href="/assets/js/36.7812381a.js"><link rel="prefetch" href="/assets/js/37.5f9f2adb.js"><link rel="prefetch" href="/assets/js/38.118ba1f4.js"><link rel="prefetch" href="/assets/js/39.b67f7277.js"><link rel="prefetch" href="/assets/js/4.9e7532a1.js"><link rel="prefetch" href="/assets/js/40.e55debb3.js"><link rel="prefetch" href="/assets/js/41.d7903d06.js"><link rel="prefetch" href="/assets/js/42.77614d76.js"><link rel="prefetch" href="/assets/js/43.b81eee3a.js"><link rel="prefetch" href="/assets/js/44.4ade92d1.js"><link rel="prefetch" href="/assets/js/45.8bea4d57.js"><link rel="prefetch" href="/assets/js/46.3bdb04e6.js"><link rel="prefetch" href="/assets/js/47.c894c4b2.js"><link rel="prefetch" href="/assets/js/48.78e60e2b.js"><link rel="prefetch" href="/assets/js/49.9c5c8f7d.js"><link rel="prefetch" href="/assets/js/5.a3c90268.js"><link rel="prefetch" href="/assets/js/50.832279c4.js"><link rel="prefetch" href="/assets/js/51.cc16f222.js"><link rel="prefetch" href="/assets/js/52.b28aa4d0.js"><link rel="prefetch" href="/assets/js/53.ebabf090.js"><link rel="prefetch" href="/assets/js/54.28bdfc99.js"><link rel="prefetch" href="/assets/js/55.a1b4df06.js"><link rel="prefetch" href="/assets/js/56.6fb0c31d.js"><link rel="prefetch" href="/assets/js/57.b9df5c2d.js"><link rel="prefetch" href="/assets/js/58.47940a92.js"><link rel="prefetch" href="/assets/js/6.4133d95a.js"><link rel="prefetch" href="/assets/js/7.ea728375.js"><link rel="prefetch" href="/assets/js/8.b6825a68.js"><link rel="prefetch" href="/assets/js/9.4d493f14.js">
    <link rel="stylesheet" href="/assets/css/0.styles.83e51879.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Jeffery Blog</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue/vue-home.html" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/web/javascript/home.html" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/web/typescript/guide.html" class="nav-link">TypeScript</a></li><li class="dropdown-item"><!----> <a href="/web/html/" class="nav-link">HTML</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/vscode/shortcut-key.html" class="nav-link">VS Code</a></li><li class="dropdown-item"><!----> <a href="/tools/git/basics.html" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/tools/gitlab/webhook.html" class="nav-link">GitLab</a></li><li class="dropdown-item"><!----> <a href="/tools/develop/doc.html" class="nav-link">工具库</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端基建</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/infrastructure/performance/01-optimize-index.html" class="nav-link">性能优化</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/JefferyXZF" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue/vue-home.html" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/web/javascript/home.html" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/web/typescript/guide.html" class="nav-link">TypeScript</a></li><li class="dropdown-item"><!----> <a href="/web/html/" class="nav-link">HTML</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/vscode/shortcut-key.html" class="nav-link">VS Code</a></li><li class="dropdown-item"><!----> <a href="/tools/git/basics.html" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/tools/gitlab/webhook.html" class="nav-link">GitLab</a></li><li class="dropdown-item"><!----> <a href="/tools/develop/doc.html" class="nav-link">工具库</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端基建</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/infrastructure/performance/01-optimize-index.html" class="nav-link">性能优化</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/JefferyXZF" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <!----> </div> <div class="page"> <div class="content"><h1 id="从零搭建组件库框架"><a href="#从零搭建组件库框架" class="header-anchor">#</a> 从零搭建组件库框架</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>最近 <code>Vue3</code> 正式发布了，它在性能方面做了很大的改善，使用了很多新的技术，例如 <code>Typescript</code>、<code>Proxy</code>、<code>响应式API</code> 等等。所以学习掌握它肯定没错啦。</p> <p>在开源社区，<code>Element</code> 组件库官方不在维护了，刚好某课吧团队使用 <code>Vue3</code> 对他进行重构，这对自己来说是个不错的学习机会，可以和大家一起“造轮子”。</p> <p>接下来说说“造轮子”对自己的利弊：好的方面有很多，比如学习如何规范设计目录、组件库的开发、发布、构建流程、自动化测试、学习掌握 <code>Vue3</code> 、<code>Typescript</code> 技术、提高自己的工程能力等，弊端就是要花大量时间和精力去学习，出去浪的机会少了，不过对于上进的渣渣前端来说这都不是事。</p> <p>先来学习下 <code>ElementUI</code> 的源码的目录结构。</p> <h2 id="目录结构解析"><a href="#目录结构解析" class="header-anchor">#</a> 目录结构解析</h2> <ul><li><code>github</code>：存放 <code>Element UI 贡献指南</code>、<code>Issue 规范</code> 、 <code>Pull Request 规范</code> 、<code>开发环境搭建</code>、<code>组件开发规范</code>、<code>代码规范</code> 文件</li> <li><code>build</code>：存放打包相关的配置文件</li> <li><code>examples</code>：组件相关示例 <code>demo</code></li> <li><code>packages</code>：组件源码</li> <li><code>src</code>：存放入口文件和一些工具辅助函数</li> <li><code>test</code>：单元测试相关文件，测试覆盖率是优秀的开源项目必备条件</li> <li><code>types</code>：类型声明文件</li></ul> <p>说完文件目录，认识一下根目录其他几个文件</p> <p><img src="/images/component/direct.png" alt="目录结构"></p> <ul><li><code>.travis.yml</code>：持续集成 <code>(CI)</code> 的配置文件</li> <li><code>CHANGELOG</code>：更新日志记录文件</li> <li><code>components.json</code>：标明了组件的文件路径，方便 <code>webpack</code> 打包时获取组件的文件路径。</li> <li><code>FAQ.md</code>：<code>ElementUI</code> 开发者对常见问题的解答。</li> <li><code>LICENSE</code>：开源许可证，<code>Element UI</code>使用的是<code>MIT</code>协议</li> <li><code>Makefile</code>：<a href="https://seisman.github.io/how-to-write-makefile/overview.html" target="_blank" rel="noopener noreferrer">Makefile<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是一个适用于 <code>C/C++</code> 的工具，在拥有 <code>make</code> 环境的目录下， 如果存在一个 <code>Makefile</code> 文件。 那么输入 <code>make</code> 命令将会执行 <code>Makefile</code> 文件中的某个目标命令。</li></ul> <h2 id="package-json"><a href="#package-json" class="header-anchor">#</a> package.json</h2> <p>如何快速的熟悉一个项目，<code>package.json</code> 文件是一个突破口，它包含了项目的版本、入口、脚本命令、依赖等关键信息。</p> <p>先来分析几个关键字段</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;lib/element-ui.common.js&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;files&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token string">&quot;lib&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;src&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;packages&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;types&quot;</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token property">&quot;typings&quot;</span><span class="token operator">:</span> <span class="token string">&quot;types/index.d.ts&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;unpkg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;lib/index.js&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;style&quot;</span><span class="token operator">:</span> <span class="token string">&quot;lib/theme-chalk/index.css&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="main"><a href="#main" class="header-anchor">#</a> main</h3> <p>项目的入口文件</p> <p><code>lib/element-ui.common.js</code> 是 <code>commonjs</code> 规范，而 <code>lib/index.js</code> 是 <code>umd</code> 规范</p> <h3 id="files"><a href="#files" class="header-anchor">#</a> files</h3> <p>指定 <code>npm publish</code> 发包时需要包含的文件/目录。</p> <h3 id="typings"><a href="#typings" class="header-anchor">#</a> typings</h3> <p><code>TypeScript</code>入口文件。</p> <h3 id="unpkg"><a href="#unpkg" class="header-anchor">#</a> unpkg</h3> <p>当把一个包发布到 <code>npm</code> 上时，它同时应该也可以在<code>unpkg</code>上获取到。也就是说，你的代码既可能在<code>NodeJs</code>环境也可能在<code>浏览器环境</code>执行。为此你需要用<code>umd</code>格式打包，<code>lib/index.js</code> 是<code>umd</code>规范，由<code>webpack.conf.js</code>生成。</p> <h3 id="style"><a href="#style" class="header-anchor">#</a> style</h3> <p>声明样式入口文件，这里是 <code>lib/theme-chalk/index.css</code>，后面也会详细说明。</p> <h3 id="scripts"><a href="#scripts" class="header-anchor">#</a> scripts</h3> <p>开发、测试、生产构建，打包、部署，测试用例等相关脚本。<code>scripts</code>算是<code>package.json</code>中最重要的部分了，下面我会一一对其中的重要指令进行说明。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bootstrap&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm i&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build:file&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node build/bin/iconInit.js &amp; node build/bin/build-entry.js &amp; node build/bin/i18n.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build:theme&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node build/bin/gen-cssfile &amp;&amp; gulp build --gulpfile packages/theme-chalk/gulpfile.js &amp;&amp; cp-cli packages/theme-chalk/lib lib/theme-chalk&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build:utils&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env BABEL_ENV=utils babel src --out-dir lib --ignore src/index.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build:umd&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node build/bin/build-locale.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;clean&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rimraf lib &amp;&amp; rimraf packages/*/lib &amp;&amp; rimraf test/**/coverage&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;deploy:build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run build:file &amp;&amp; cross-env NODE_ENV=production webpack --config build/webpack.demo.js &amp;&amp; echo element.eleme.io&gt;&gt;examples/element-ui/CNAME&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;deploy:extension&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=production webpack --config build/webpack.extension.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dev:extension&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rimraf examples/extension/dist &amp;&amp; cross-env NODE_ENV=development webpack --watch --config build/webpack.extension.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run build:file &amp;&amp; cross-env NODE_ENV=development webpack-dev-server --config build/webpack.demo.js &amp; node build/bin/template.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dev:play&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run build:file &amp;&amp; cross-env NODE_ENV=development PLAY_ENV=true webpack-dev-server --config build/webpack.demo.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dist&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run clean &amp;&amp; npm run build:file &amp;&amp; npm run lint &amp;&amp; webpack --config build/webpack.conf.js &amp;&amp; webpack --config build/webpack.common.js &amp;&amp; webpack --config build/webpack.component.js &amp;&amp; npm run build:utils &amp;&amp; npm run build:umd &amp;&amp; npm run build:theme&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;i18n&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node build/bin/i18n.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;pub&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run bootstrap &amp;&amp; sh build/git-release.sh &amp;&amp; sh build/release.sh &amp;&amp; node build/bin/gen-indices.js &amp;&amp; sh build/deploy-faas.sh&quot;</span><span class="token punctuation">,</span>

    <span class="token property">&quot;build:docs&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run build:file &amp;&amp; cross-env NODE_ENV=development webpack --config build/webpack.demo.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eslint --no-error-on-unmatched-pattern --ext .vue --ext .js --ext .jsx packages/**/ src/**/ --fix&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jest --runInBand&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;changelog&quot;</span><span class="token operator">:</span> <span class="token string">&quot;conventional-changelog -p angular -i CHANGELOG.md -s&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build:next&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rollup -c&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;release&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node scripts/release.js&quot;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="bootstrap"><a href="#bootstrap" class="header-anchor">#</a> bootstrap</h3> <p>安装依赖， 官方推荐优先选用<code>yarn</code> ，它会锁定版本</p> <h3 id="build-file"><a href="#build-file" class="header-anchor">#</a> build:file</h3> <p>该指令主要用来自动化生成一些文件。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;build:file&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node build/bin/iconInit.js &amp; node build/bin/build-entry.js &amp; node build/bin/i18n.js &amp; node build/bin/version.js&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>该指令执行了几个文件，拆开来看：</p> <h4 id="node-build-bin-iconinit-js"><a href="#node-build-bin-iconinit-js" class="header-anchor">#</a> <code>node build/bin/iconInit.js</code></h4> <p>执行 <code>build/bin/iconInit.js</code> 文件，读取 <code>icon.scss</code>，把所有的 <code>icon</code> 的名字输出到 <code>icon.json</code> 文件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> postcss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postcss'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> fontFile <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>
  path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../packages/theme-chalk/src/icon.scss'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">'utf8'</span>
<span class="token punctuation">)</span>
<span class="token keyword">var</span> nodes <span class="token operator">=</span> postcss<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fontFile<span class="token punctuation">)</span><span class="token punctuation">.</span>nodes
<span class="token keyword">var</span> classList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> selector <span class="token operator">=</span> node<span class="token punctuation">.</span>selector <span class="token operator">||</span> <span class="token string">''</span>
  <span class="token keyword">var</span> reg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.el-icon-([^:]+):before</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
  <span class="token keyword">var</span> arr <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>arr <span class="token operator">&amp;&amp;</span> arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    classList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

classList<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 希望按 css 文件顺序倒序排列</span>

fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>
  path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../examples/icon.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>classList<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>将 <code>icon.json</code> 文件 <code>icon</code> 的名字挂在<code>Vue</code>原型上的<code>$icon</code>上。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// examples/entry.js</span>
<span class="token keyword">import</span> icon <span class="token keyword">from</span> <span class="token string">'./icon.json'</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">.</span>$icon <span class="token operator">=</span> icon
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>最后通过遍历 <code>$icon</code>，得到了官网图标的效果：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>icon-list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name in $icon<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">'</span>el-icon-<span class="token punctuation">'</span> + name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>icon-name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{'el-icon-' + name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="node-build-bin-build-entry-js"><a href="#node-build-bin-build-entry-js" class="header-anchor">#</a> <code>node build/bin/build-entry.js</code></h4> <p>根据 <code>components.json</code> 文件，生成<code>src/index.js</code>文件，核心是 <code>json-templater/string</code> 插件的使用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 根据 components.json 生成 src/index.js 文件</span>
<span class="token comment">// 引入所有组件的依赖关系</span>
<span class="token keyword">var</span> Components <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../../components.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// https://www.npmjs.com/package/json-templater 可以让string与变量结合 输出一些内容</span>
<span class="token keyword">var</span> render <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;json-templater/string&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// https://github.com/SamVerschueren/uppercamelcase  转化为驼峰 foo-bar &gt;&gt; FooBar</span>
<span class="token keyword">var</span> uppercamelcase <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;uppercamelcase&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// os.EOL属性是一个常量，返回当前操作系统的换行符（Windows系统是\r\n，其他系统是\n）</span>
<span class="token keyword">var</span> endOfLine <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;os&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token constant">EOL</span><span class="token punctuation">;</span>

<span class="token comment">// 生成文件的名字和路径</span>
<span class="token keyword">var</span> <span class="token constant">OUTPUT_PATH</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../../src/index.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">IMPORT_TEMPLATE</span> <span class="token operator">=</span>
<span class="token string">&quot;import {{name}} from '../packages/{{package}}/index.js';&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">INSTALL_COMPONENT_TEMPLATE</span> <span class="token operator">=</span> <span class="token string">&quot;  {{name}}&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// var MAIN_TEMPLATE = `/* Automatically generated by './build/bin/build-entry.js' */</span>
<span class="token comment">// ...</span>
<span class="token comment">// 获取所有组件的名字，存放在数组中</span>
<span class="token keyword">var</span> ComponentNames <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>Components<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> includeComponentTemplate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> installTemplate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> listTemplate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
ComponentNames<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> componentName <span class="token operator">=</span> <span class="token function">uppercamelcase</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  includeComponentTemplate<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token constant">IMPORT_TEMPLATE</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> componentName<span class="token punctuation">,</span>
    <span class="token keyword">package</span><span class="token operator">:</span> name<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>
<span class="token punctuation">[</span>
<span class="token string">&quot;Loading&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;MessageBox&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;Notification&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;Message&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;InfiniteScroll&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>componentName<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  installTemplate<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token constant">INSTALL_COMPONENT_TEMPLATE</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> componentName<span class="token punctuation">,</span>
    component<span class="token operator">:</span> name<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>componentName <span class="token operator">!==</span> <span class="token string">&quot;Loading&quot;</span><span class="token punctuation">)</span> listTemplate<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> template <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token constant">MAIN_TEMPLATE</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    include<span class="token operator">:</span> includeComponentTemplate<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>endOfLine<span class="token punctuation">)</span><span class="token punctuation">,</span>
    install<span class="token operator">:</span> installTemplate<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> endOfLine<span class="token punctuation">)</span><span class="token punctuation">,</span>
    version<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VERSION</span> <span class="token operator">||</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../../package.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token punctuation">,</span>
    list<span class="token operator">:</span> listTemplate<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> endOfLine<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 结果输出到src/index.js中</span>
fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token constant">OUTPUT_PATH</span><span class="token punctuation">,</span> template<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;[build entry] DONE:&quot;</span><span class="token punctuation">,</span> <span class="token constant">OUTPUT_PATH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><p>所以通过上面代码可以看出，<code>src/index.js</code> 文件是由 <code>build/bin/build-entry.js</code> 脚本自动构建的</p> <h4 id="node-build-bin-i18n-js"><a href="#node-build-bin-i18n-js" class="header-anchor">#</a> <code>node build/bin/i18n.js</code></h4> <p>执行该文件目的是根据 <code>examples/i18n/page.json</code> 和 <code>examples/pages/template</code> 模版，生成不同语言的 <code>demo</code>，也就是官网 demo 展示国际化的处理。</p> <p><img src="/images/component/tpl.png" alt="模板文件"></p> <p>这里面都是<code>.tpl</code>文件，每个文件对应一个模版，而且每个<code>tpl</code>文件都是符合<code>SFC</code>规范的<code>Vue</code>文件。</p> <p>里面都有数字标示了需要国际化处理的地方。</p> <p>首页所有国际化相关的字段对应关系存储在 <code>examples/i18n/page.json</code> 中：</p> <p><img src="/images/component/i8n.png" alt="模板文件"></p> <p>最终官网展示出来的就是经过上面国际化处理后的页面：</p> <p>那么，<code>build/bin/i18n.js</code> 是如何做到根据不同语言，生成不同 <code>vue</code> 文件呢？来看下对应的源码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">'use strict'</span>

<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> langConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../examples/i18n/page.json'</span><span class="token punctuation">)</span>

langConfig<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">lang</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../../examples/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lang<span class="token punctuation">.</span>lang<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../../examples/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lang<span class="token punctuation">.</span>lang<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>lang<span class="token punctuation">.</span>pages<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">page</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> templatePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
      __dirname<span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../../examples/pages/template/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>page<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.tpl</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
    <span class="token keyword">var</span> outputPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
      __dirname<span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../../examples/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lang<span class="token punctuation">.</span>lang<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>page<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.vue</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
    <span class="token keyword">var</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>templatePath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> pairs <span class="token operator">=</span> lang<span class="token punctuation">.</span>pages<span class="token punctuation">[</span>page<span class="token punctuation">]</span>

    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>pairs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      content <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;%=\\s*</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\s*&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        pairs<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">,</span> content<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>处理流程：遍历 <code>examples/i18n/page.json</code> ，根据不同的数据结构把 <code>tpl</code> 文件的标志位，通过正则匹配出来，并替换成自己预先设定好的字段。</p> <h3 id="build-bin-version-js"><a href="#build-bin-version-js" class="header-anchor">#</a> build/bin/version.js</h3> <p>根据<code>package.json</code>中的<code>version</code>,生成<code>examples/versions.json</code>，对应就是完整的版本列表</p> <h3 id="build-theme"><a href="#build-theme" class="header-anchor">#</a> build:theme</h3> <p>处理样式相关。 <code>build:theme</code> 命令同样和 <code>build:file</code> 一样，执行了一组命令，拆开分析</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;build:theme&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node build/bin/gen-cssfile &amp;&amp; gulp build --gulpfile packages/theme-chalk/gulpfile.js &amp;&amp; cp-cli packages/theme-chalk/lib lib/theme-chalk&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="node-build-bin-gen-cssfile"><a href="#node-build-bin-gen-cssfile" class="header-anchor">#</a> <code>node build/bin/gen-cssfile</code></h4> <p>这一步是根据<code>components.json</code>，生成 <code>package/theme-chalk/index.scss</code> 文件，把所有组件的样式都导入到<code>index.scss</code>。</p> <p>其实是做了一个自动化导入操作，后面每次新增组件，就不用手动去引入新增组件的样式了。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> Components <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../components.json'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> themes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'theme-chalk'</span><span class="token punctuation">]</span>
Components <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>Components<span class="token punctuation">)</span>
<span class="token keyword">var</span> basepath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../packages/'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">fileExists</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

themes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">theme</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> isSCSS <span class="token operator">=</span> theme <span class="token operator">!==</span> <span class="token string">'theme-default'</span>
  <span class="token keyword">var</span> indexContent <span class="token operator">=</span> isSCSS
    <span class="token operator">?</span> <span class="token string">'@import &quot;./base.scss&quot;;\n'</span>
    <span class="token operator">:</span> <span class="token string">'@import &quot;./base.css&quot;;\n'</span>
  Components<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'icon'</span><span class="token punctuation">,</span> <span class="token string">'option'</span><span class="token punctuation">,</span> <span class="token string">'option-group'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">var</span> fileName <span class="token operator">=</span> key <span class="token operator">+</span> <span class="token punctuation">(</span>isSCSS <span class="token operator">?</span> <span class="token string">'.scss'</span> <span class="token operator">:</span> <span class="token string">'.css'</span><span class="token punctuation">)</span>
    indexContent <span class="token operator">+=</span> <span class="token string">'@import &quot;./'</span> <span class="token operator">+</span> fileName <span class="token operator">+</span> <span class="token string">'&quot;;\n'</span>
    <span class="token keyword">var</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>basepath<span class="token punctuation">,</span> theme<span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fileExists</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>theme<span class="token punctuation">,</span> <span class="token string">' 创建遗漏的 '</span><span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> <span class="token string">' 文件'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>
    path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>basepath<span class="token punctuation">,</span> theme<span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">,</span> isSCSS <span class="token operator">?</span> <span class="token string">'index.scss'</span> <span class="token operator">:</span> <span class="token string">'index.css'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    indexContent
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h4 id="gulp-build-–gulpfile-packages-theme-chalk-gulpfile-js"><a href="#gulp-build-–gulpfile-packages-theme-chalk-gulpfile-js" class="header-anchor">#</a> <code>gulp build –gulpfile packages/theme-chalk/gulpfile.js</code></h4> <p>使用 <code>gulp</code> 打包 <code>scss</code> 样式文件，它的目的是可以实现样式全局引入和按需引入。在使用 <code>CDN</code> 会看到全局引入一个 <code>index.css</code> 文件，按需引入组件只是把单独的样式文件引入。</p> <ul><li>全局引入</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ElementUI <span class="token keyword">from</span> <span class="token string">&quot;element-ui&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;element-ui/lib/theme-chalk/index.css&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&quot;./App.vue&quot;</span><span class="token punctuation">;</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>ElementUI<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
el<span class="token operator">:</span> <span class="token string">&quot;#app&quot;</span><span class="token punctuation">,</span>
<span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>按需引入</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Pagination<span class="token punctuation">,</span> Dropdown <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;element-ui&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&quot;./App.vue&quot;</span><span class="token punctuation">;</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Pagination<span class="token punctuation">)</span><span class="token punctuation">;</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Dropdown<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
el<span class="token operator">:</span> <span class="token string">&quot;#app&quot;</span><span class="token punctuation">,</span>
<span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>对应两种引入方式，<code>Element</code> 两种方案。</p> <p>具体如下：将<code>packages/theme-chalk</code>下的所有<code>scss</code>文件编译为<code>css</code>，当你需要全局引入时，就去引入<code>index.scss</code>文件；当你按需引入时，引入对应的组件<code>scss</code>文件即可。</p> <p>这其中有一点，我们需要思考下：如何把<code>packages/theme-chalk</code>下的所有<code>scss</code>文件编译为<code>css</code>？</p> <p>在平时的开发中，我们打包、压缩之类的工作往往都会交给<code>webpack</code>去处理，但是，针对上面这个问题，我们如果采用<code>gulp</code>基于工作流去处理会更加方便。</p> <p><code>gulp</code>相关的处理就在<code>packages/theme-chalk/gulpfile.js</code>中：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">'use strict'</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> series<span class="token punctuation">,</span> src<span class="token punctuation">,</span> dest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sass'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> autoprefixer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-autoprefixer'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> cssmin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-cssmin'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'./src/*.scss'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>sass<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      <span class="token function">autoprefixer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        browsers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'ie &gt; 9'</span><span class="token punctuation">,</span> <span class="token string">'last 2 versions'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        cascade<span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">cssmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'./lib'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">copyfont</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'./src/fonts/**'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">cssmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'./lib/fonts'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

exports<span class="token punctuation">.</span>build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> copyfont<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>经过处理，最终就会打包出对应的样式文件</p> <h4 id="cp-cli-packages-theme-chalk-lib-lib-theme-chalk"><a href="#cp-cli-packages-theme-chalk-lib-lib-theme-chalk" class="header-anchor">#</a> <code>cp-cli packages/theme-chalk/lib lib/theme-chalk</code></h4> <p>这里就是复制文件到<code>lib/theme-chalk</code>下</p> <p>以上 <code>build:theme</code> 命令就说完了，接下来介绍一下几个重要的目录文件</p> <h2 id="components-json"><a href="#components-json" class="header-anchor">#</a> components.json</h2> <p>这个文件其实就是记录了组件的路径，在自动化生成文件以及入口时会用到：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
<span class="token property">&quot;pagination&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./packages/pagination/index.js&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;dialog&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./packages/dialog/index.js&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;autocomplete&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./packages/autocomplete/index.js&quot;</span><span class="token punctuation">,</span>
<span class="token comment">// ...</span>
<span class="token property">&quot;avatar&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./packages/avatar/index.js&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;drawer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./packages/drawer/index.js&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;popconfirm&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./packages/popconfirm/index.js&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="packages"><a href="#packages" class="header-anchor">#</a> packages</h2> <p>存放着组件库的源码和组件样式文件。</p> <p>这里以<code>Alert</code>组件为例做下说明：</p> <h3 id="alert-文件夹"><a href="#alert-文件夹" class="header-anchor">#</a> Alert 文件夹</h3> <p><img src="/images/component/alert.png" alt="模板文件"></p> <p>这里 <code>Alert.vue</code> 对应是组件源码，而 <code>index.js</code>是入口文件, <code>Alert.spect.js</code> 是单元测试文件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> ElAlert <span class="token keyword">from</span> <span class="token string">'./Alert.vue'</span>

<span class="token comment">/* istanbul ignore next */</span>
ElAlert<span class="token punctuation">.</span><span class="token function-variable function">install</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span>ElAlert<span class="token punctuation">.</span>name<span class="token punctuation">,</span> ElAlert<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ElAlert
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>引入组件，然后为组件提供 <code>install</code> 方法，让 <code>Vue</code> 可以通过 <code>Vue.use(Alert)</code> 去使用。</p> <h2 id="packages-theme-chalk"><a href="#packages-theme-chalk" class="header-anchor">#</a> packages/theme-chalk</h2> <p>这里面存放的就是所有组件相关的样式，上面也已经做过说明了，里面有<code>index.scss</code>（用于全局引入时导出所有组件样式）和其他每个组件对应的<code>scss</code>文件（用于按需引入时导出对应的组件样式）</p> <h2 id="src"><a href="#src" class="header-anchor">#</a> src</h2> <p>上面的<code>packages</code>文件夹是分开去处理每个组件，而<code>src</code>的作用就是把所有的组件做一个统一处理，同时包含自定义指令、项目整体入口、组件国际化、组件 mixins、动画的封装和公共方法。</p> <p><img src="/images/component/src.png" alt="模板文件"></p> <p>我们主要来看下入口文件，也就是<code>src/index.js</code>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/* Automatically generated by './build/bin/build-entry.js' */</span>
<span class="token comment">// 导入了packages下的所有组件</span>
<span class="token keyword">import</span> Pagination <span class="token keyword">from</span> <span class="token string">&quot;../packages/pagination/index.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Dialog <span class="token keyword">from</span> <span class="token string">&quot;../packages/dialog/index.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Autocomplete <span class="token keyword">from</span> <span class="token string">&quot;../packages/autocomplete/index.js&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
<span class="token keyword">const</span> components <span class="token operator">=</span> <span class="token punctuation">[</span>
Pagination<span class="token punctuation">,</span>
Dialog<span class="token punctuation">,</span>
Autocomplete<span class="token punctuation">,</span>
<span class="token comment">// ...</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 提供了install方法，帮我们挂载了一些组件与变量</span>
<span class="token keyword">const</span> <span class="token function-variable function">install</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">Vue<span class="token punctuation">,</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
locale<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>locale<span class="token punctuation">)</span><span class="token punctuation">;</span>
locale<span class="token punctuation">.</span><span class="token function">i18n</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>i18n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 把所有的组件注册到Vue上面</span>
components<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">component</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span>component<span class="token punctuation">.</span>name<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>InfiniteScroll<span class="token punctuation">)</span><span class="token punctuation">;</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Loading<span class="token punctuation">.</span>directive<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$<span class="token constant">ELEMENT</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
size<span class="token operator">:</span> opts<span class="token punctuation">.</span>size <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
zIndex<span class="token operator">:</span> opts<span class="token punctuation">.</span>zIndex <span class="token operator">||</span> <span class="token number">2000</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$loading <span class="token operator">=</span> Loading<span class="token punctuation">.</span>service<span class="token punctuation">;</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$msgbox <span class="token operator">=</span> MessageBox<span class="token punctuation">;</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$alert <span class="token operator">=</span> MessageBox<span class="token punctuation">.</span>alert<span class="token punctuation">;</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$confirm <span class="token operator">=</span> MessageBox<span class="token punctuation">.</span>confirm<span class="token punctuation">;</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$prompt <span class="token operator">=</span> MessageBox<span class="token punctuation">.</span>prompt<span class="token punctuation">;</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$notify <span class="token operator">=</span> Notification<span class="token punctuation">;</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$message <span class="token operator">=</span> Message<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/* istanbul ignore if */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">install</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 导出版本号、install方法（插件）、以及一些功能比如国际化功能</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
version<span class="token operator">:</span> <span class="token string">&quot;2.13.2&quot;</span><span class="token punctuation">,</span>
locale<span class="token operator">:</span> locale<span class="token punctuation">.</span>use<span class="token punctuation">,</span>
i18n<span class="token operator">:</span> locale<span class="token punctuation">.</span>i18n<span class="token punctuation">,</span>
install<span class="token punctuation">,</span>
Pagination<span class="token punctuation">,</span>
Dialog<span class="token punctuation">,</span>
Autocomplete<span class="token punctuation">,</span>
<span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>文件开头的：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/* Automatically generated by './build/bin/build-entry.js' */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其实在上面的<code>scripts</code>的<code>build/bin/build-entry.js</code> 中已经提到过：<code>src/index.js</code> 是由 <code>build-entry</code> 脚本自动生成的。</p> <p>这个文件主要做下以下事情：</p> <ul><li>导入了 <code>packages</code> 下的所有组件</li> <li>对外暴露了<code>install</code>方法，把所有的组件注册到<code>Vue</code>上面，并在<code>Vue</code>原型上挂载了一些全局变量和方法</li> <li>最终将<code>install</code>方法、变量、方法导出</li></ul> <h2 id="examples"><a href="#examples" class="header-anchor">#</a> examples</h2> <p>存放了 <code>ElementUI</code>的组件示例。</p> <p><img src="/images/component/examples.png" alt="模板文件"></p> <p>从目录结构，不难看出这是一个完整独立的<code>Vue</code>项目。主要用于官方文档的展示：</p> <p>这里主要关注下<code>docs</code>文件夹：</p> <p><img src="/images/component/docs.png" alt="模板文件"></p> <p>可以看到里面全部都是 <code>md</code> 文档，<code>Element</code> 对 <code>Markdown</code> 文件的处理使用了自己写的 <code>loader</code> 文件转换，每一个<code>md</code>文档，分别对应着官网组件的展示页面。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.md$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
  use<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">'vue-loader'</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        compilerOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
          preserveWhitespace<span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./md-loader/index.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>上面大致了解了组件库源码的几个主要文件目录。下面我们从构建指令到新建组件、打包流程、发布组件完整的看一下构建流程。</p> <h2 id="构建流程梳理"><a href="#构建流程梳理" class="header-anchor">#</a> 构建流程梳理</h2> <h3 id="构建指令（makefile）"><a href="#构建指令（makefile）" class="header-anchor">#</a> 构建指令（Makefile）</h3> <p><code>ElementUI</code> 使用了 <code>Makefile</code> 文件管理构建命令，当输入 <code>make</code> 命令，会执行定义好的一组命令</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>.PHONY: dist <span class="token builtin class-name">test</span>
default: <span class="token builtin class-name">help</span>
<span class="token comment"># build all theme</span>
build-theme:
<span class="token function">npm</span> run build:theme
install:
<span class="token function">npm</span> <span class="token function">install</span>
install-cn:
<span class="token function">npm</span> <span class="token function">install</span> --registry<span class="token operator">=</span>http://registry.npm.taobao.org
dev:
<span class="token function">npm</span> run dev
play:
<span class="token function">npm</span> run dev:play
new:
node build/bin/new.js <span class="token variable"><span class="token variable">$(</span>filter-out <span class="token punctuation">[</span>email protected<span class="token punctuation">]</span>,<span class="token punctuation">$(</span>MAKECMDGOALS<span class="token punctuation">)</span><span class="token variable">)</span></span>
dist: <span class="token function">install</span>
<span class="token function">npm</span> run dist
deploy:
@npm run deploy
pub:
<span class="token function">npm</span> run pub
test:
<span class="token function">npm</span> run test:watch
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>以<code>make new</code>为例简要说明下执行流程：</p> <ul><li>执行 <code>make</code> 命令， 在该目录下找到 <code>Makefile</code> 文件。</li> <li>找到 <code>Makefile</code> 文件中对应命令行参数的 <code>new</code> 目标。这里的目标是 <code>node build/bin/new.js $(filter-out [email protected],$(MAKECMDGOALS))</code></li></ul> <p>这个文件比较大，就不粘贴代码了，可以看<a href="https://github.com/ElemeFE/element/blob/dev/build/bin/new.js" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，用法和介绍如下：</p> <p>make new <code>&lt;component-name&gt;</code> [中文]</p> <ul><li>1、将新建组件添加到 <code>components.json</code></li> <li>2、添加到 <code>index.scss</code></li> <li>3、添加到 <code>element-ui.d.ts</code></li> <li>4、创建 <code>package</code></li> <li>5、添加到 <code>nav.config.json</code></li></ul> <h2 id="构建入口文件"><a href="#构建入口文件" class="header-anchor">#</a> 构建入口文件</h2> <p>看下 <code>scripts</code> 中的 <code>dev</code> 指令：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run bootstrap &amp;&amp; npm run build:file &amp;&amp; cross-env NODE_ENV=development webpack-dev-server --config build webpack.demo.js &amp; node build/bin/template.js&quot;</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>首先 <code>npm run bootstrap</code> 是用来安装依赖的。</p> <p><code>npm run build:file</code> 在前面也有提到，主要用来自动化生成一些文件。主要是 <code>node build/bin/build-entry.js</code>，用于生成<code>Element</code>的入口<code>js</code>：先是读取根目录的<code>components.json</code>，这个<code>json</code>文件维护着<code>Element</code>所有的组件路径映射关系，键为组件名，值为组件源码的入口文件；然后遍历键值，将所有组件进行<code>import</code>，对外暴露<code>install</code>方法，把所有<code>import</code>的组件通过<code>Vue.component(name, component)</code>方式注册为全局组件，并且把一些弹窗类的组件挂载到<code>Vue</code>的原型链上（这个在上面介绍<code>scripts</code>相关脚本时有详细说明）。</p> <p>在生成了入口文件的<code>src/index.js</code>之后就会运行<code>webpack-dev-server</code>。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>webpack-dev-server --config build/webpack.demo.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这个前面也提过，用于跑<code>Element</code>官网的基础配置。</p> <h2 id="新建组件"><a href="#新建组件" class="header-anchor">#</a> 新建组件</h2> <p>上面提到了，<code>Element</code> 中用了 <code>makefile</code> 为编写了一些额外的脚本。</p> <p>这里重点说一下 <code>make new &lt;component-name&gt; [中文]</code> 这个命令。</p> <p>当运行这个命令的时候，其实运行的是 <code>node build/bin/new.js</code>。</p> <p><code>build/bin/new.js</code>比较简单，备注也很清晰，它帮我们做了下面几件事：</p> <p>1、新建的组件添加到<code>components.json</code></p> <p>2、在<code>packages/theme-chalk/src</code>下新建对应到组件<code>scss</code>文件，并添加到<code>packages/theme-chalk/src/index.scss</code>中</p> <p>3、添加到 <code>element-ui.d.ts</code>，也就是对应的类型声明文件</p> <p>4、创建<code>package</code>（我们上面有提到组件相关的源码都在<code>package</code>目录下存放）</p> <p>5、添加到<code>nav.config.json</code>（也就是官网<code>组件</code>左侧的菜单）</p> <h2 id="打包流程分析"><a href="#打包流程分析" class="header-anchor">#</a> 打包流程分析</h2> <p><code>ElementUI</code>打包执行的脚本是：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;dist&quot;</span><span class="token operator">:</span> &quot;npm run clean &amp;&amp; npm run build<span class="token operator">:</span>file &amp;&amp; 
npm run lint &amp;&amp; 
webpack --config build/webpack.conf.js &amp;&amp; webpack --config build/webpack.common.js &amp;&amp; webpack --config build/webpack.component.js &amp;&amp;
npm run build<span class="token operator">:</span>utils &amp;&amp;
npm run build<span class="token operator">:</span>umd &amp;&amp;
npm run build<span class="token operator">:</span>theme&quot;<span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>下面一一来进行分析：</p> <h4 id="npm-run-clean（清理文件）"><a href="#npm-run-clean（清理文件）" class="header-anchor">#</a> npm run clean（清理文件）</h4> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;clean&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rimraf lib &amp;&amp; rimraf packages/*/lib &amp;&amp; rimraf test/**/coverage&quot;</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>删除之前打包生成文件。</p> <h4 id="npm-run-build-file（生成入口文件）"><a href="#npm-run-build-file（生成入口文件）" class="header-anchor">#</a> npm run build:file（生成入口文件）</h4> <p>根据 <code>components.json</code> 生成入口文件 <code>src/index.js</code>，以及<code>i18n</code>相关文件。这个在上面已经做过分析，这里就不再展开进行说明。</p> <h4 id="npm-run-lint（代码检查）"><a href="#npm-run-lint（代码检查）" class="header-anchor">#</a> npm run lint（代码检查）</h4> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;lint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eslint src/**/* test/**/* packages/**/* build/**/* --quiet&quot;</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>项目<code>eslint</code>检测，这也是现在项目必备的。</p> <h4 id="文件打包相关"><a href="#文件打包相关" class="header-anchor">#</a> 文件打包相关</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>webpack --config build/webpack.conf.js <span class="token operator">&amp;&amp;</span>
webpack --config build/webpack.common.js <span class="token operator">&amp;&amp;</span>
webpack --config build/webpack.component.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="build-webpack-conf-js"><a href="#build-webpack-conf-js" class="header-anchor">#</a> <code>build/webpack.conf.js</code></h5> <p>生成<code>umd</code>格式的<code>js</code>文件（index.js）</p> <h5 id="build-webpack-common-js"><a href="#build-webpack-common-js" class="header-anchor">#</a> <code>build/webpack.common.js</code></h5> <p>生成<code>commonjs</code>格式的<code>js</code>文件（element-ui.common.js），<code>require</code>时默认加载的是这个文件。</p> <h5 id="build-webpack-component-js"><a href="#build-webpack-component-js" class="header-anchor">#</a> <code>build/webpack.component.js</code></h5> <p>以<code>components.json</code>为入口，将每一个组件打包生成一个文件，用于按需加载。</p> <h4 id="npm-run-build-utils（转译工具方法）"><a href="#npm-run-build-utils（转译工具方法）" class="header-anchor">#</a> npm run build:utils（转译工具方法）</h4> <p>把 <code>src</code> 目录下的除了<code>index.js</code>入口文件外的其他文件通过<code>babel</code>转译，然后移动到<code>lib</code>文件夹下。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;build:utils&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env BABEL_ENV=utils babel src --out-dir lib --ignore src/index.js&quot;</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="npm-run-build-umd（语言包）"><a href="#npm-run-build-umd（语言包）" class="header-anchor">#</a> npm run build:umd（语言包）</h4> <p>生成<code>umd</code>模块的语言包。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;build:umd&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node build/bin/build-locale.js&quot;</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="npm-run-build-theme（生成样式文件）"><a href="#npm-run-build-theme（生成样式文件）" class="header-anchor">#</a> npm run build:theme（生成样式文件）</h4> <p>根据<code>components.json</code>，生成<code>package/theme-chalk/index.scss</code>。用<code>gulp</code>构建工具，编译<code>scss</code>、压缩、输出<code>css</code>到<code>lib</code>目录。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;build:theme&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node build/bin/gen-cssfile &amp;&amp; gulp build --gulpfile packages/theme-chalk/gulpfile.js &amp;&amp; cp-cli packages/theme-chalk/lib lib/theme-chalk&quot;</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>最后用一张图来描述上述整个打包流程：</p> <p><img src="/images/component/bundle.png" alt="模板文件"></p> <h2 id="发布流程"><a href="#发布流程" class="header-anchor">#</a> 发布流程</h2> <p>打包完成，紧跟着就是代码的发布了。<code>Element</code>中发布主要是用<code>shell</code>脚本实现的。</p> <p><code>Element</code>发布一共涉及三个部分：</p> <p>1、git 发布</p> <p>2、npm 发布</p> <p>3、官网发布</p> <p>发布对应的脚本是：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;pub&quot;</span><span class="token operator">:</span> &quot;npm run bootstrap &amp;&amp; 
sh build/git-release.sh &amp;&amp; 
sh build/release.sh &amp;&amp; 
node build/bin/gen-indices.js &amp;&amp; 
sh build/deploy-faas.sh&quot;<span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="sh-build-git-release-sh（代码冲突检测）"><a href="#sh-build-git-release-sh（代码冲突检测）" class="header-anchor">#</a> sh build/git-release.sh（代码冲突检测）</h4> <p>运行 <code>git-release.sh</code> 进行<code>git</code>冲突的检测，这里主要是检测<code>dev</code>分支是否冲突，因为<code>Element</code>是在<code>dev</code>分支进行开发的。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token shebang important">#!/usr/bin/env sh</span>
<span class="token comment"># 切换至dev分支</span>
<span class="token function">git</span> checkout dev
<span class="token comment"># 检测本地和暂存区是否还有未提交的文件</span>
<span class="token keyword">if</span> <span class="token builtin class-name">test</span> -n <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">git</span> status --porcelain<span class="token variable">)</span></span>&quot;</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
<span class="token builtin class-name">echo</span> <span class="token string">'Unclean working tree. Commit or stash changes first.'</span> <span class="token operator">&gt;</span><span class="token file-descriptor important">&amp;2</span><span class="token punctuation">;</span>
<span class="token builtin class-name">exit</span> <span class="token number">128</span><span class="token punctuation">;</span>
<span class="token keyword">fi</span>
<span class="token comment"># 检测本地分支是否有误</span>
<span class="token keyword">if</span> <span class="token operator">!</span> <span class="token function">git</span> fetch --quiet <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
<span class="token builtin class-name">echo</span> <span class="token string">'There was a problem fetching your branch. Run <span class="token variable"><span class="token variable">`</span><span class="token function">git</span> fetch<span class="token variable">`</span></span> to see more...'</span> <span class="token operator">&gt;</span><span class="token file-descriptor important">&amp;2</span><span class="token punctuation">;</span>
<span class="token builtin class-name">exit</span> <span class="token number">128</span><span class="token punctuation">;</span>
<span class="token keyword">fi</span>
<span class="token comment"># 检测本地分支是否落后远程分支</span>
<span class="token keyword">if</span> <span class="token builtin class-name">test</span> <span class="token string">&quot;0&quot;</span> <span class="token operator">!=</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">git</span> rev-list --count --left-only @<span class="token string">'{u}'</span><span class="token punctuation">..</span>.HEAD<span class="token variable">)</span></span>&quot;</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
<span class="token builtin class-name">echo</span> <span class="token string">'Remote history differ. Please pull changes.'</span> <span class="token operator">&gt;</span><span class="token file-descriptor important">&amp;2</span><span class="token punctuation">;</span>
<span class="token builtin class-name">exit</span> <span class="token number">128</span><span class="token punctuation">;</span>
<span class="token keyword">fi</span>
<span class="token comment"># 通过以上检查，表示代码无冲突</span>
<span class="token builtin class-name">echo</span> <span class="token string">'No conflicts.'</span> <span class="token operator">&gt;</span><span class="token file-descriptor important">&amp;2</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="发布-npm-官网更新"><a href="#发布-npm-官网更新" class="header-anchor">#</a> 发布 npm &amp;&amp; 官网更新</h4> <p><code>dev</code>分支代码检测没有冲突，接下来就会执行<code>release.sh</code>脚本，合并<code>dev</code>分支到<code>master</code>、更新版本号、推送代码到远程仓库并发布到<code>npm</code>（npm publish）。</p> <p>官网更新大致就是：将静态资源生成到<code>examples/element-ui</code>目录下，然后放到<code>gh-pages</code>分支，这样就能通过<code>github pages</code>的方式访问。</p> <p>到这里<code>ElementUI</code>的完整构建流程就分析完了。</p> <h2 id="搭建组件库总结"><a href="#搭建组件库总结" class="header-anchor">#</a> 搭建组件库总结</h2> <p>通过对 <code>ElementUI</code> 源码文件和构建流程的分析，下面我们可以总结一下搭建一个完备的 UI 组件库需要做什么工作。</p> <h3 id="目录结构"><a href="#目录结构" class="header-anchor">#</a> 目录结构</h3> <p>目录结构对于大型项目是尤其重要的，合理清晰的结构对于后期的开发和扩展都是很有意义的。<code>UI</code> 组件库的目录结构，感觉<code>ElementUI</code>的就很不错：</p> <div class="language-JS line-numbers-mode"><pre class="language-js"><code><span class="token operator">|</span><span class="token operator">--</span> Element
<span class="token operator">|</span><span class="token operator">--</span> <span class="token punctuation">.</span>babelrc                           <span class="token comment">// babel相关配置</span>
<span class="token operator">|</span><span class="token operator">--</span> <span class="token punctuation">.</span>eslintignore
<span class="token operator">|</span><span class="token operator">--</span> <span class="token punctuation">.</span>eslintrc                          <span class="token comment">// eslint相关配置</span>
<span class="token operator">|</span><span class="token operator">--</span> <span class="token punctuation">.</span>gitattributes
<span class="token operator">|</span><span class="token operator">--</span> <span class="token punctuation">.</span>gitignore
<span class="token operator">|</span><span class="token operator">--</span> <span class="token punctuation">.</span>travis<span class="token punctuation">.</span>yml                        <span class="token comment">// ci配置</span>
<span class="token operator">|</span><span class="token operator">--</span> <span class="token constant">CHANGELOG</span><span class="token punctuation">.</span>en<span class="token operator">-</span><span class="token constant">US</span><span class="token punctuation">.</span>md
<span class="token operator">|</span><span class="token operator">--</span> <span class="token constant">CHANGELOG</span><span class="token punctuation">.</span>es<span class="token punctuation">.</span>md
<span class="token operator">|</span><span class="token operator">--</span> <span class="token constant">CHANGELOG</span><span class="token punctuation">.</span>fr<span class="token operator">-</span><span class="token constant">FR</span><span class="token punctuation">.</span>md
<span class="token operator">|</span><span class="token operator">--</span> <span class="token constant">CHANGELOG</span><span class="token punctuation">.</span>zh<span class="token operator">-</span><span class="token constant">CN</span><span class="token punctuation">.</span>md                 <span class="token comment">// 版本改动说明</span>
<span class="token operator">|</span><span class="token operator">--</span> <span class="token constant">FAQ</span><span class="token punctuation">.</span>md                             <span class="token comment">// 常见问题QA</span>
<span class="token operator">|</span><span class="token operator">--</span> <span class="token constant">LICENSE</span>                            <span class="token comment">// 版权协议相关</span>
<span class="token operator">|</span><span class="token operator">--</span> Makefile                           <span class="token comment">// 脚本集合（工程化编译）</span>
<span class="token operator">|</span><span class="token operator">--</span> <span class="token constant">README</span><span class="token punctuation">.</span>md                          <span class="token comment">// 项目说明文档</span>
<span class="token operator">|</span><span class="token operator">--</span> components<span class="token punctuation">.</span>json                    <span class="token comment">// 组件配置文件</span>
<span class="token operator">|</span><span class="token operator">--</span> element_logo<span class="token punctuation">.</span>svg
<span class="token operator">|</span><span class="token operator">--</span> <span class="token keyword">package</span><span class="token punctuation">.</span>json
<span class="token operator">|</span><span class="token operator">--</span> yarn<span class="token punctuation">.</span>lock
<span class="token operator">|</span><span class="token operator">--</span> <span class="token punctuation">.</span>github                            <span class="token comment">// 贡献者、issue、PR模版</span>
<span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">--</span> <span class="token constant">CONTRIBUTING</span><span class="token punctuation">.</span>en<span class="token operator">-</span><span class="token constant">US</span><span class="token punctuation">.</span>md
<span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">--</span> <span class="token constant">CONTRIBUTING</span><span class="token punctuation">.</span>es<span class="token punctuation">.</span>md
<span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">--</span> <span class="token constant">CONTRIBUTING</span><span class="token punctuation">.</span>fr<span class="token operator">-</span><span class="token constant">FR</span><span class="token punctuation">.</span>md
<span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">--</span> <span class="token constant">CONTRIBUTING</span><span class="token punctuation">.</span>zh<span class="token operator">-</span><span class="token constant">CN</span><span class="token punctuation">.</span>md
<span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">--</span> <span class="token constant">ISSUE_TEMPLATE</span><span class="token punctuation">.</span>md
<span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">--</span> <span class="token constant">PULL_REQUEST_TEMPLATE</span><span class="token punctuation">.</span>md
<span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">--</span> stale<span class="token punctuation">.</span>yml
<span class="token operator">|</span><span class="token operator">--</span> build                              <span class="token comment">// 打包</span>
<span class="token operator">|</span><span class="token operator">--</span> examples                           <span class="token comment">// 示例代码</span>
<span class="token operator">|</span><span class="token operator">--</span> packages                           <span class="token comment">// 组件源码</span>
<span class="token operator">|</span><span class="token operator">--</span> src                                <span class="token comment">// 入口文件以及各种辅助文件</span>
<span class="token operator">|</span><span class="token operator">--</span> test                               <span class="token comment">// 单元测试文件</span>
<span class="token operator">|</span><span class="token operator">--</span> types                              <span class="token comment">// 类型声明</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="组件开发"><a href="#组件开发" class="header-anchor">#</a> 组件开发</h3> <p>参考大多数 <code>UI</code> 组件库的做法，可以将 <code>examples</code> 下的示例代码组织起来并暴露一个入口，使用 <code>webpack</code> 配置一个 <code>dev-server</code>，后续对组件的调试、运行都在此 <code>dev-server</code> 下进行。</p> <h3 id="单元测试"><a href="#单元测试" class="header-anchor">#</a> 单元测试</h3> <p><code>UI</code> 组件作为高度抽象的基础公共组件，编写单元测试是很有必要的。合格的单元测试也是一个成熟的开源项目必备的。</p> <h3 id="打包"><a href="#打包" class="header-anchor">#</a> 打包</h3> <p>对于打包后的文件，统一放在 <code>lib</code> 目录下，同时记得要在 <code>.gitignore</code> 中加上 <code>lib</code> 目录，避免将打包结果提交到代码库中。</p> <p>同时针对引入方式的不同，要提供<code>全局引入</code>（UMD）和<code>按需加载</code>两种形式的包。</p> <h3 id="文档"><a href="#文档" class="header-anchor">#</a> 文档</h3> <p>组件库的文档一般都是对外可访问的，因此需要部署到服务器上，同时也需具备本地预览的功能。</p> <h3 id="发布"><a href="#发布" class="header-anchor">#</a> 发布</h3> <p>组件库的某个版本完成开发工作后，需要将包发布到 npm 上。发布流程：</p> <ul><li>执行测试用例</li> <li>打包构建</li> <li>更新版本号</li> <li>npm 包发布</li> <li>打 tag</li> <li>自动化部署</li></ul> <h3 id="维护"><a href="#维护" class="header-anchor">#</a> 维护</h3> <p>发布后需要日常维护之前老版本，一般需要注意一下几点：</p> <ul><li>issue(bug 修复)</li> <li>pull request（代码 pr）</li> <li>CHANGELOG.md(版本改动记录)</li> <li>CONTRIBUTING.md（项目贡献者及规范）</li></ul></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.f96d0dc8.js" defer></script><script src="/assets/js/11.2ac88bab.js" defer></script>
  </body>
</html>
